/*****************************************************************
 * This file is generated by gen-types.py. Do not edit manually. *
 *****************************************************************/

package llambda.boxedtype

import llambda.codegen.llvmir._
import llambda.InternalCompilerErrorException

sealed abstract class BoxedType {
  val name : String
  val irType : FirstClassType
  val supertype : Option[BoxedType]
  val directSubtypes : Set[BoxedType]
  val isAbstract : Boolean
  val tbaaIndex : Int

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget)

  def isTypeOrSubtypeOf(otherType : BoxedType) : Boolean = {
    if (otherType == this) {
      return true
    }

    supertype map (_.isTypeOrSubtypeOf(otherType)) getOrElse false
  }

  def isTypeOrSupertypeOf(otherType : BoxedType) : Boolean = {
    if (otherType == this) {
      return true
    }

    directSubtypes exists (_.isTypeOrSupertypeOf(otherType))
  }

  def concreteTypes : Set[ConcreteBoxedType] = this match {
    case concreteType : ConcreteBoxedType => Set(concreteType)
    case abstractType => directSubtypes.flatMap(_.concreteTypes)
  }

  def genPointerBitcast(block : IrBlockBuilder)(uncastValue : IrValue) : IrValue =
    if (uncastValue.irType == PointerType(irType)) {
      uncastValue
    }
    else {
      block.bitcastTo(name + "Cast")(uncastValue, PointerType(irType))
    }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue
  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit
  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue
  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit
  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue
}

sealed abstract class ConcreteBoxedType extends BoxedType {
  val typeId : Int
}

object BoxedDatum extends BoxedType {
  val name = "datum"
  val irType = UserDefinedType("datum")
  val supertype = None
  val directSubtypes = Set[BoxedType](BoxedUnspecific, BoxedListElement, BoxedStringLike, BoxedBoolean, BoxedNumeric, BoxedCharacter, BoxedVector, BoxedBytevector, BoxedRecordLike, BoxedMutableVar)
  val isAbstract = true
  val tbaaIndex = 0

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)

  def createConstant(typeId : Long) : StructureConstant = {
    StructureConstant(List(
      IntegerConstant(typeIdIrType, typeId),
      IntegerConstant(gcStateIrType, 0)
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    startBlock.uncondBranch(successBlock)
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("datum"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %datum*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("datum"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %datum*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedUnspecific extends ConcreteBoxedType {
  val name = "unspecific"
  val irType = UserDefinedType("unspecific")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 1
  val typeId = 0

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (0L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("unspecific"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %unspecific*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("unspecific"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %unspecific*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedListElement extends BoxedType {
  val name = "listElement"
  val irType = UserDefinedType("listElement")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType](BoxedPair, BoxedEmptyList)
  val isAbstract = true
  val tbaaIndex = 2

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)

  def createConstant(typeId : Long) : StructureConstant = {
    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      )
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (1L -> successBlock), (2L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("listElement"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %listElement*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("listElement"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %listElement*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedPair extends ConcreteBoxedType {
  val name = "pair"
  val irType = UserDefinedType("pair")
  val supertype = Some(BoxedListElement)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 3
  val typeId = 1

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val carIrType = PointerType(UserDefinedType("datum"))
  val cdrIrType = PointerType(UserDefinedType("datum"))

  def createConstant(car : IrConstant, cdr : IrConstant) : StructureConstant = {
    if (car.irType != carIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field car")
    }

    if (cdr.irType != cdrIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field cdr")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      car,
      cdr
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (1L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("pair"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %pair*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("pair"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %pair*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToCar(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("pair"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %pair*")
    }

    block.getelementptr("carPtr")(
      elementType=carIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToCar(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val carPointer = genPointerToCar(block)(boxedValue)
    block.store(toStore, carPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromCar(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val carPointer = genPointerToCar(block)(boxedValue)
    block.load("car")(carPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToCdr(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("pair"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %pair*")
    }

    block.getelementptr("cdrPtr")(
      elementType=cdrIrType,
      basePointer=boxedValue,
      indices=List(0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToCdr(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val cdrPointer = genPointerToCdr(block)(boxedValue)
    block.store(toStore, cdrPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromCdr(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val cdrPointer = genPointerToCdr(block)(boxedValue)
    block.load("cdr")(cdrPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedEmptyList extends ConcreteBoxedType {
  val name = "emptyList"
  val irType = UserDefinedType("emptyList")
  val supertype = Some(BoxedListElement)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 4
  val typeId = 2

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (2L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("emptyList"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %emptyList*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("emptyList"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %emptyList*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedStringLike extends BoxedType {
  val name = "stringLike"
  val irType = UserDefinedType("stringLike")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType](BoxedString, BoxedSymbol)
  val isAbstract = true
  val tbaaIndex = 5

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val charLengthIrType = IntegerType(32)
  val byteLengthIrType = IntegerType(32)
  val utf8DataIrType = PointerType(IntegerType(8))

  def createConstant(charLength : Long, byteLength : Long, utf8Data : IrConstant, typeId : Long) : StructureConstant = {
    if (utf8Data.irType != utf8DataIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field utf8Data")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      IntegerConstant(charLengthIrType, charLength),
      IntegerConstant(byteLengthIrType, byteLength),
      utf8Data
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (3L -> successBlock), (4L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("stringLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %stringLike*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("stringLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %stringLike*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToCharLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("stringLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %stringLike*")
    }

    block.getelementptr("charLengthPtr")(
      elementType=charLengthIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToCharLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val charLengthPointer = genPointerToCharLength(block)(boxedValue)
    block.store(toStore, charLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromCharLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val charLengthPointer = genPointerToCharLength(block)(boxedValue)
    block.load("charLength")(charLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToByteLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("stringLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %stringLike*")
    }

    block.getelementptr("byteLengthPtr")(
      elementType=byteLengthIrType,
      basePointer=boxedValue,
      indices=List(0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToByteLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val byteLengthPointer = genPointerToByteLength(block)(boxedValue)
    block.store(toStore, byteLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromByteLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val byteLengthPointer = genPointerToByteLength(block)(boxedValue)
    block.load("byteLength")(byteLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToUtf8Data(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("stringLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %stringLike*")
    }

    block.getelementptr("utf8DataPtr")(
      elementType=utf8DataIrType,
      basePointer=boxedValue,
      indices=List(0, 3).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToUtf8Data(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val utf8DataPointer = genPointerToUtf8Data(block)(boxedValue)
    block.store(toStore, utf8DataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromUtf8Data(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val utf8DataPointer = genPointerToUtf8Data(block)(boxedValue)
    block.load("utf8Data")(utf8DataPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedString extends ConcreteBoxedType {
  val name = "string"
  val irType = UserDefinedType("string")
  val supertype = Some(BoxedStringLike)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 6
  val typeId = 3

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val charLengthIrType = IntegerType(32)
  val byteLengthIrType = IntegerType(32)
  val utf8DataIrType = PointerType(IntegerType(8))

  def createConstant(charLength : Long, byteLength : Long, utf8Data : IrConstant) : StructureConstant = {
    StructureConstant(List(
      supertype.get.createConstant(
        charLength=charLength,
        byteLength=byteLength,
        utf8Data=utf8Data,
        typeId=typeId
      )
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (3L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("string"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %string*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("string"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %string*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToCharLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("string"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %string*")
    }

    block.getelementptr("charLengthPtr")(
      elementType=charLengthIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToCharLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val charLengthPointer = genPointerToCharLength(block)(boxedValue)
    block.store(toStore, charLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromCharLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val charLengthPointer = genPointerToCharLength(block)(boxedValue)
    block.load("charLength")(charLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToByteLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("string"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %string*")
    }

    block.getelementptr("byteLengthPtr")(
      elementType=byteLengthIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToByteLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val byteLengthPointer = genPointerToByteLength(block)(boxedValue)
    block.store(toStore, byteLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromByteLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val byteLengthPointer = genPointerToByteLength(block)(boxedValue)
    block.load("byteLength")(byteLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToUtf8Data(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("string"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %string*")
    }

    block.getelementptr("utf8DataPtr")(
      elementType=utf8DataIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 3).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToUtf8Data(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val utf8DataPointer = genPointerToUtf8Data(block)(boxedValue)
    block.store(toStore, utf8DataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromUtf8Data(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val utf8DataPointer = genPointerToUtf8Data(block)(boxedValue)
    block.load("utf8Data")(utf8DataPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedSymbol extends ConcreteBoxedType {
  val name = "symbol"
  val irType = UserDefinedType("symbol")
  val supertype = Some(BoxedStringLike)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 7
  val typeId = 4

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val charLengthIrType = IntegerType(32)
  val byteLengthIrType = IntegerType(32)
  val utf8DataIrType = PointerType(IntegerType(8))

  def createConstant(charLength : Long, byteLength : Long, utf8Data : IrConstant) : StructureConstant = {
    StructureConstant(List(
      supertype.get.createConstant(
        charLength=charLength,
        byteLength=byteLength,
        utf8Data=utf8Data,
        typeId=typeId
      )
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (4L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("symbol"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %symbol*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("symbol"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %symbol*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToCharLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("symbol"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %symbol*")
    }

    block.getelementptr("charLengthPtr")(
      elementType=charLengthIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToCharLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val charLengthPointer = genPointerToCharLength(block)(boxedValue)
    block.store(toStore, charLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromCharLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val charLengthPointer = genPointerToCharLength(block)(boxedValue)
    block.load("charLength")(charLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToByteLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("symbol"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %symbol*")
    }

    block.getelementptr("byteLengthPtr")(
      elementType=byteLengthIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToByteLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val byteLengthPointer = genPointerToByteLength(block)(boxedValue)
    block.store(toStore, byteLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromByteLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val byteLengthPointer = genPointerToByteLength(block)(boxedValue)
    block.load("byteLength")(byteLengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToUtf8Data(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("symbol"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %symbol*")
    }

    block.getelementptr("utf8DataPtr")(
      elementType=utf8DataIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 3).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToUtf8Data(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val utf8DataPointer = genPointerToUtf8Data(block)(boxedValue)
    block.store(toStore, utf8DataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromUtf8Data(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val utf8DataPointer = genPointerToUtf8Data(block)(boxedValue)
    block.load("utf8Data")(utf8DataPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedBoolean extends ConcreteBoxedType {
  val name = "boolean"
  val irType = UserDefinedType("boolean")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 8
  val typeId = 5

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val valueIrType = IntegerType(8)

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (5L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("boolean"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %boolean*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("boolean"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %boolean*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("boolean"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %boolean*")
    }

    block.getelementptr("valuePtr")(
      elementType=valueIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToValue(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val valuePointer = genPointerToValue(block)(boxedValue)
    block.store(toStore, valuePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val valuePointer = genPointerToValue(block)(boxedValue)
    block.load("value")(valuePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedNumeric extends BoxedType {
  val name = "numeric"
  val irType = UserDefinedType("numeric")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType](BoxedExactInteger, BoxedInexactRational)
  val isAbstract = true
  val tbaaIndex = 9

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)

  def createConstant(typeId : Long) : StructureConstant = {
    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      )
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (6L -> successBlock), (7L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("numeric"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %numeric*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("numeric"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %numeric*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedExactInteger extends ConcreteBoxedType {
  val name = "exactInteger"
  val irType = UserDefinedType("exactInteger")
  val supertype = Some(BoxedNumeric)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 10
  val typeId = 6

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val valueIrType = IntegerType(64)

  def createConstant(value : Long) : StructureConstant = {
    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      IntegerConstant(valueIrType, value)
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (6L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("exactInteger"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %exactInteger*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("exactInteger"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %exactInteger*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("exactInteger"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %exactInteger*")
    }

    block.getelementptr("valuePtr")(
      elementType=valueIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToValue(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val valuePointer = genPointerToValue(block)(boxedValue)
    block.store(toStore, valuePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val valuePointer = genPointerToValue(block)(boxedValue)
    block.load("value")(valuePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedInexactRational extends ConcreteBoxedType {
  val name = "inexactRational"
  val irType = UserDefinedType("inexactRational")
  val supertype = Some(BoxedNumeric)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 11
  val typeId = 7

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val valueIrType = DoubleType

  def createConstant(value : IrConstant) : StructureConstant = {
    if (value.irType != valueIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field value")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      value
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (7L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("inexactRational"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %inexactRational*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("inexactRational"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %inexactRational*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("inexactRational"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %inexactRational*")
    }

    block.getelementptr("valuePtr")(
      elementType=valueIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToValue(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val valuePointer = genPointerToValue(block)(boxedValue)
    block.store(toStore, valuePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val valuePointer = genPointerToValue(block)(boxedValue)
    block.load("value")(valuePointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedCharacter extends ConcreteBoxedType {
  val name = "character"
  val irType = UserDefinedType("character")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 12
  val typeId = 8

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val unicodeCharIrType = IntegerType(32)

  def createConstant(unicodeChar : IrConstant) : StructureConstant = {
    if (unicodeChar.irType != unicodeCharIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field unicodeChar")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      unicodeChar
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (8L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("character"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %character*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("character"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %character*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToUnicodeChar(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("character"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %character*")
    }

    block.getelementptr("unicodeCharPtr")(
      elementType=unicodeCharIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToUnicodeChar(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val unicodeCharPointer = genPointerToUnicodeChar(block)(boxedValue)
    block.store(toStore, unicodeCharPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromUnicodeChar(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val unicodeCharPointer = genPointerToUnicodeChar(block)(boxedValue)
    block.load("unicodeChar")(unicodeCharPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedVector extends ConcreteBoxedType {
  val name = "vector"
  val irType = UserDefinedType("vector")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 13
  val typeId = 9

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val lengthIrType = IntegerType(32)
  val elementsIrType = PointerType(PointerType(UserDefinedType("datum")))

  def createConstant(length : Long, elements : IrConstant) : StructureConstant = {
    if (elements.irType != elementsIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field elements")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      IntegerConstant(lengthIrType, length),
      elements
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (9L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("vector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %vector*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("vector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %vector*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("vector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %vector*")
    }

    block.getelementptr("lengthPtr")(
      elementType=lengthIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val lengthPointer = genPointerToLength(block)(boxedValue)
    block.store(toStore, lengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val lengthPointer = genPointerToLength(block)(boxedValue)
    block.load("length")(lengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToElements(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("vector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %vector*")
    }

    block.getelementptr("elementsPtr")(
      elementType=elementsIrType,
      basePointer=boxedValue,
      indices=List(0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToElements(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val elementsPointer = genPointerToElements(block)(boxedValue)
    block.store(toStore, elementsPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromElements(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val elementsPointer = genPointerToElements(block)(boxedValue)
    block.load("elements")(elementsPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedBytevector extends ConcreteBoxedType {
  val name = "bytevector"
  val irType = UserDefinedType("bytevector")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 14
  val typeId = 10

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val lengthIrType = IntegerType(32)
  val dataIrType = PointerType(IntegerType(8))

  def createConstant(length : Long, data : IrConstant) : StructureConstant = {
    if (data.irType != dataIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field data")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      IntegerConstant(lengthIrType, length),
      data
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (10L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("bytevector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %bytevector*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("bytevector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %bytevector*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("bytevector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %bytevector*")
    }

    block.getelementptr("lengthPtr")(
      elementType=lengthIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToLength(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val lengthPointer = genPointerToLength(block)(boxedValue)
    block.store(toStore, lengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromLength(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val lengthPointer = genPointerToLength(block)(boxedValue)
    block.load("length")(lengthPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("bytevector"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %bytevector*")
    }

    block.getelementptr("dataPtr")(
      elementType=dataIrType,
      basePointer=boxedValue,
      indices=List(0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToData(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val dataPointer = genPointerToData(block)(boxedValue)
    block.store(toStore, dataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val dataPointer = genPointerToData(block)(boxedValue)
    block.load("data")(dataPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedRecordLike extends BoxedType {
  val name = "recordLike"
  val irType = UserDefinedType("recordLike")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType](BoxedProcedure, BoxedRecord)
  val isAbstract = true
  val tbaaIndex = 15

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val recordClassIdIrType = IntegerType(32)
  val recordDataIrType = PointerType(IntegerType(8))

  def createConstant(recordClassId : Long, recordData : IrConstant, typeId : Long) : StructureConstant = {
    if (recordData.irType != recordDataIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field recordData")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      IntegerConstant(recordClassIdIrType, recordClassId),
      recordData
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (11L -> successBlock), (12L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("recordLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %recordLike*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("recordLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %recordLike*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToRecordClassId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("recordLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %recordLike*")
    }

    block.getelementptr("recordClassIdPtr")(
      elementType=recordClassIdIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToRecordClassId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val recordClassIdPointer = genPointerToRecordClassId(block)(boxedValue)
    block.store(toStore, recordClassIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromRecordClassId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val recordClassIdPointer = genPointerToRecordClassId(block)(boxedValue)
    block.load("recordClassId")(recordClassIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToRecordData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("recordLike"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %recordLike*")
    }

    block.getelementptr("recordDataPtr")(
      elementType=recordDataIrType,
      basePointer=boxedValue,
      indices=List(0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToRecordData(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val recordDataPointer = genPointerToRecordData(block)(boxedValue)
    block.store(toStore, recordDataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromRecordData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val recordDataPointer = genPointerToRecordData(block)(boxedValue)
    block.load("recordData")(recordDataPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedProcedure extends ConcreteBoxedType {
  val name = "procedure"
  val irType = UserDefinedType("procedure")
  val supertype = Some(BoxedRecordLike)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 16
  val typeId = 11

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val recordClassIdIrType = IntegerType(32)
  val recordDataIrType = PointerType(IntegerType(8))
  val entryPointIrType = PointerType(FunctionType(PointerType(UserDefinedType("datum")), List(PointerType(IntegerType(8)), PointerType(UserDefinedType("listElement")) )))

  def createConstant(entryPoint : IrConstant, recordClassId : Long, recordData : IrConstant) : StructureConstant = {
    if (entryPoint.irType != entryPointIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field entryPoint")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        recordClassId=recordClassId,
        recordData=recordData,
        typeId=typeId
      ),
      entryPoint
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (11L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("procedure"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %procedure*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("procedure"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %procedure*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToRecordClassId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("procedure"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %procedure*")
    }

    block.getelementptr("recordClassIdPtr")(
      elementType=recordClassIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToRecordClassId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val recordClassIdPointer = genPointerToRecordClassId(block)(boxedValue)
    block.store(toStore, recordClassIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromRecordClassId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val recordClassIdPointer = genPointerToRecordClassId(block)(boxedValue)
    block.load("recordClassId")(recordClassIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToRecordData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("procedure"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %procedure*")
    }

    block.getelementptr("recordDataPtr")(
      elementType=recordDataIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToRecordData(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val recordDataPointer = genPointerToRecordData(block)(boxedValue)
    block.store(toStore, recordDataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromRecordData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val recordDataPointer = genPointerToRecordData(block)(boxedValue)
    block.load("recordData")(recordDataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToEntryPoint(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("procedure"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %procedure*")
    }

    block.getelementptr("entryPointPtr")(
      elementType=entryPointIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToEntryPoint(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val entryPointPointer = genPointerToEntryPoint(block)(boxedValue)
    block.store(toStore, entryPointPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromEntryPoint(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val entryPointPointer = genPointerToEntryPoint(block)(boxedValue)
    block.load("entryPoint")(entryPointPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedRecord extends ConcreteBoxedType {
  val name = "record"
  val irType = UserDefinedType("record")
  val supertype = Some(BoxedRecordLike)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 17
  val typeId = 12

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val recordClassIdIrType = IntegerType(32)
  val recordDataIrType = PointerType(IntegerType(8))

  def createConstant(recordClassId : Long, recordData : IrConstant) : StructureConstant = {
    StructureConstant(List(
      supertype.get.createConstant(
        recordClassId=recordClassId,
        recordData=recordData,
        typeId=typeId
      )
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (12L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("record"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %record*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("record"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %record*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToRecordClassId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("record"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %record*")
    }

    block.getelementptr("recordClassIdPtr")(
      elementType=recordClassIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToRecordClassId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val recordClassIdPointer = genPointerToRecordClassId(block)(boxedValue)
    block.store(toStore, recordClassIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromRecordClassId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val recordClassIdPointer = genPointerToRecordClassId(block)(boxedValue)
    block.load("recordClassId")(recordClassIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToRecordData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("record"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %record*")
    }

    block.getelementptr("recordDataPtr")(
      elementType=recordDataIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 2).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToRecordData(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val recordDataPointer = genPointerToRecordData(block)(boxedValue)
    block.store(toStore, recordDataPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromRecordData(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val recordDataPointer = genPointerToRecordData(block)(boxedValue)
    block.load("recordData")(recordDataPointer, tbaaIndex=Some(tbaaIndex))
  }
}

object BoxedMutableVar extends ConcreteBoxedType {
  val name = "mutableVar"
  val irType = UserDefinedType("mutableVar")
  val supertype = Some(BoxedDatum)
  val directSubtypes = Set[BoxedType]()
  val isAbstract = false
  val tbaaIndex = 18
  val typeId = 13

  val typeIdIrType = IntegerType(8)
  val gcStateIrType = IntegerType(8)
  val currentValueIrType = PointerType(UserDefinedType("datum"))

  def createConstant(currentValue : IrConstant) : StructureConstant = {
    if (currentValue.irType != currentValueIrType) {
      throw new InternalCompilerErrorException("Unexpected type for field currentValue")
    }

    StructureConstant(List(
      supertype.get.createConstant(
        typeId=typeId
      ),
      currentValue
    ), userDefinedType=Some(irType))
  }

  def genTypeCheck(startBlock : IrBlockBuilder)(boxedValue : IrValue, successBlock : IrBranchTarget, failBlock : IrBranchTarget) {
    val datumValue = BoxedDatum.genPointerBitcast(startBlock)(boxedValue)
    val typeId = BoxedDatum.genLoadFromTypeId(startBlock)(datumValue)
    startBlock.switch(typeId, failBlock, (13L -> successBlock))
  }

  def genPointerToTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("mutableVar"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %mutableVar*")
    }

    block.getelementptr("typeIdPtr")(
      elementType=typeIdIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 0).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToTypeId(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.store(toStore, typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromTypeId(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val typeIdPointer = genPointerToTypeId(block)(boxedValue)
    block.load("typeId")(typeIdPointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("mutableVar"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %mutableVar*")
    }

    block.getelementptr("gcStatePtr")(
      elementType=gcStateIrType,
      basePointer=boxedValue,
      indices=List(0, 0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToGcState(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.store(toStore, gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromGcState(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val gcStatePointer = genPointerToGcState(block)(boxedValue)
    block.load("gcState")(gcStatePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genPointerToCurrentValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    if (boxedValue.irType != PointerType(UserDefinedType("mutableVar"))) {
       throw new InternalCompilerErrorException(s"Unexpected type for boxed value. Passed ${boxedValue.irType}, expected %mutableVar*")
    }

    block.getelementptr("currentValuePtr")(
      elementType=currentValueIrType,
      basePointer=boxedValue,
      indices=List(0, 1).map(IntegerConstant(IntegerType(32), _)),
      inbounds=true
    )
  }

  def genStoreToCurrentValue(block : IrBlockBuilder)(toStore : IrValue, boxedValue : IrValue) : Unit = {
    val currentValuePointer = genPointerToCurrentValue(block)(boxedValue)
    block.store(toStore, currentValuePointer, tbaaIndex=Some(tbaaIndex))
  }

  def genLoadFromCurrentValue(block : IrBlockBuilder)(boxedValue : IrValue) : IrValue = {
    val currentValuePointer = genPointerToCurrentValue(block)(boxedValue)
    block.load("currentValue")(currentValuePointer, tbaaIndex=Some(tbaaIndex))
  }
}

